[tox]
minversion = 3.9.0
requires =
    tox-ansible
; pip >= 2.20.3

envlist =
    lint
    # keep only N,N-1 ansible versions
    py
    py-{2.9,2.10,2.11,devel}

# do not enable skip missing to avoid CI false positives
skip_missing_interpreters = False
isolated_build = True
# this is not a python package, no install
skipsdist = True

[testenv]
usedevelop = False
# do not put * in passenv as it may break builds do to reduced isolation
passenv =
    CI
    CONTAINER_*
    DOCKER_*
    GITHUB_*
    HOME
    PIP_*
    PODMAN_*
    PUBLISH
    PYTEST_*
    SSH_AUTH_SOCK
    TERM
setenv =
    ANSIBLE_CONFIG={toxinidir}/.ansible.cfg
    ANSIBLE_DISPLAY_FAILED_STDERR=1
    ANSIBLE_VERBOSITY=1
    MOLECULE_NO_LOG=0
    PYTHONDONTWRITEBYTECODE=1
    PYTHONUNBUFFERED=1
    _EXTRAS=-l
deps =
    2.9: ansible>=2.9,<2.10
    2.10: ansible-base>=2.10,<2.11
    2.11: ansible-core>=2.11.0rc2,<2.12
    devel: git+https://github.com/ansible/ansible#egg=ansible-core
    selinux
    pytest
    py{36,37}: importlib-metadata<2,>=0.12

commands =
    ansibledevel: ansible-galaxy install git+https://github.com/ansible-collections/community.general.git
    # failsafe as pip may install incompatible dependencies
    pip check
    # failsafe for preventing changes that may break pytest collection
    sh -c "PYTEST_ADDOPTS= python -m pytest -p no:cov --collect-only 2>&1 >{envlogdir}/collect.log"

whitelist_externals =
    bash
    find
    rm
    sh

[testenv:lint]
description = Runs all linting tasks
commands =
    # to run a single linter you can do "pre-commit run flake8"
    python -m pre_commit run {posargs:--all}
deps = pre-commit>=1.18.1
extras =
skip_install = true
usedevelop = false
